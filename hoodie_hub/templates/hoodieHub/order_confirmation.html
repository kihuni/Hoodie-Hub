{% extends 'hoodieHub/base.html' %}

{% block title %}Order Confirmation - HoodieHub{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto px-4 md:px-6 py-8 md:py-12 bg-gray-950 min-h-screen">
    <div class="bg-gray-900 rounded-xl shadow-lg p-6 md:p-12 text-center border border-gray-800">
        <!-- Status Badge -->
        <span class="inline-block px-4 py-2 rounded-full font-bold text-xs md:text-sm mb-4 md:mb-6 {% if order.status == 'PAID' %}bg-green-900 text-green-300{% elif order.status == 'PENDING' %}bg-yellow-900 text-yellow-300{% else %}bg-red-900 text-red-300{% endif %}">
            {{ order.get_status_display }}
        </span>
        
        <!-- Title -->
        <h1 class="text-2xl md:text-4xl font-bold text-white mb-3 md:mb-4">
            {% if order.status == 'PAID' %}
                Order Confirmed! âœ“
            {% elif order.status == 'PENDING' %}
                Order Pending
            {% else %}
                Order Failed
            {% endif %}
        </h1>
        
        <!-- Message -->
        <p class="text-sm md:text-lg text-gray-400 mb-6 md:mb-8 leading-relaxed">
            {% if order.status == 'PAID' %}
                Thank you for your purchase! Your order has been confirmed.
            {% elif order.status == 'PENDING' %}
                Your order is pending. Please complete the payment on your phone.
            {% else %}
                We encountered an issue processing your payment. Please try again.
            {% endif %}
        </p>
        
        <!-- Order Details -->
        <div class="bg-gray-800 p-4 md:p-6 rounded-lg mb-6 md:mb-8 text-left border border-gray-700">
            <div class="flex flex-col md:flex-row md:justify-between py-3 border-b border-gray-700 gap-2 text-xs md:text-sm">
                <span class="font-bold text-gray-300">Order ID</span>
                <span class="text-gray-400">{{ order.id|truncatechars:12 }}</span>
            </div>
            <div class="flex flex-col md:flex-row md:justify-between py-3 border-b border-gray-700 gap-2 text-xs md:text-sm">
                <span class="font-bold text-gray-300">Customer Name</span>
                <span class="text-gray-400">{{ order.customer_name }}</span>
            </div>
            <div class="flex flex-col md:flex-row md:justify-between py-3 border-b border-gray-700 gap-2 text-xs md:text-sm">
                <span class="font-bold text-gray-300">Phone Number</span>
                <span class="text-gray-400">{{ order.phone_number }}</span>
            </div>
            <div class="flex flex-col md:flex-row md:justify-between py-3 border-b border-gray-700 gap-2 text-xs md:text-sm">
                <span class="font-bold text-gray-300">Delivery Location</span>
                <span class="text-gray-400">{{ order.delivery_location }}</span>
            </div>
            <div class="flex flex-col md:flex-row md:justify-between py-3 border-b border-gray-700 gap-2 text-xs md:text-sm">
                <span class="font-bold text-gray-300">Order Date</span>
                <span class="text-gray-400">{{ order.created_at|date:"Y-m-d H:i" }}</span>
            </div>
            {% if order.mpesa_receipt_number %}
            <div class="flex flex-col md:flex-row md:justify-between py-3 gap-2 text-xs md:text-sm">
                <span class="font-bold text-gray-300">M-Pesa Receipt</span>
                <span class="text-gray-400">{{ order.mpesa_receipt_number }}</span>
            </div>
            {% endif %}
        </div>
        
        <!-- Order Items -->
        <div class="bg-gray-800 p-4 md:p-6 rounded-lg mb-6 md:mb-8 text-left border border-gray-700">
            <h3 class="text-lg md:text-xl font-bold text-white mb-4">Order Items</h3>
            {% for item in order.items.all %}
            <div class="flex flex-col md:flex-row md:justify-between py-3 border-b border-gray-700 gap-2">
                <div class="text-xs md:text-sm">
                    <div class="font-semibold text-gray-300">{{ item.hoodie_name }}</div>
                    <small class="text-gray-500">{{ item.size }} Ã— {{ item.quantity }}</small>
                </div>
                <div class="text-gray-300 font-semibold text-xs md:text-sm">KES {{ item.get_subtotal|floatformat:2 }}</div>
            </div>
            {% endfor %}
            <div class="flex flex-col md:flex-row md:justify-between py-4 border-t-2 border-gray-700 text-lg md:text-2xl font-bold gap-2">
                <span class="text-gray-300">Total</span>
                <span class="text-purple-400">KES {{ order.total_amount|floatformat:2 }}</span>
            </div>
        </div>
        
        <!-- Status Check (if pending) -->
        {% if order.status == 'PENDING' %}
        <div class="bg-blue-900 p-3 md:p-4 rounded-lg mb-6 md:mb-8 flex items-center gap-3 justify-center text-xs md:text-base border border-blue-800">
            <div class="w-5 h-5 border-3 border-blue-700 border-t-blue-400 rounded-full animate-spin"></div>
            <span class="text-blue-300 font-semibold">Waiting for payment confirmation...</span>
        </div>
        {% endif %}
        
        <!-- Action Buttons -->
        <div class="flex flex-col gap-2 md:gap-4">
            {% if order.status == 'PAID' %}
            <a href="{% url 'hoodieHub:download_receipt' order.id %}" class="bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-bold py-3 px-4 md:px-6 rounded-lg transition active:scale-95 text-xs md:text-base text-center">
                Download Receipt ðŸ“„
            </a>
            {% endif %}
            <a href="{% url 'hoodieHub:home' %}" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 md:px-6 rounded-lg transition active:scale-95 text-xs md:text-base text-center">
                Continue Shopping
            </a>
        </div>
    </div>
</div>

{% if order.status == 'PENDING' %}
<script>
    // Check order status every 3 seconds
    const checkOrderStatus = async () => {
        try {
            const response = await fetch('{% url "hoodieHub:check_order_status" order.id %}');
            const data = await response.json();
            
            if (data.status === 'PAID') {
                // Refresh page to show paid status
                location.reload();
            }
        } catch (error) {
            console.error('Error checking status:', error);
        }
    };
    
    // Check every 3 seconds
    setInterval(checkOrderStatus, 3000);
</script>
{% endif %}
{% endblock %}
